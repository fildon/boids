(()=>{var r={boid:{alignmentRadius:40,alignmentRadiusDefault:40,attractionRadius:200,attractionRadiusDefault:200,defaultColour:"LightSteelBlue",fearDuration:30,maxSpeed:6,minSpeed:3,quantity:100,repulsionRadius:30,repulsionRadiusDefault:30,size:4,visionRadius:200},creature:{acceleration:.2,headingFuzz:.05,maxHistory:5,turningMax:1.2},hunter:{defaultColour:"pink",eatRadius:20,maxSpeed:5,minSpeed:0,quantity:0,size:8,visionRadius:90},player:{maxSpeed:64,minSpeed:0},screen:{maxX:1e3,maxY:1e3}};var n=class{static average(t){return t.length===0?new n:t.reduce((i,o)=>i.add(o)).scaleByScalar(1/t.length)}static fromHeadingAndSpeed(t,e){return e?new n(e*Math.cos(t),e*Math.sin(t)):new n(0,0)}constructor(t=0,e=0){this.x=t%r.screen.maxX,this.y=e%r.screen.maxY,this.length=Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}unitVector(){return this.scaleByScalar(1/this.length)}distance(t){return this.vectorTo(t).length}vectorTo(t){let e=(t.x-this.x)%r.screen.maxX;e>r.screen.maxX/2&&(e-=r.screen.maxX),e<-(r.screen.maxX/2)&&(e+=r.screen.maxX);let i=(t.y-this.y)%r.screen.maxY;return i>r.screen.maxY/2&&(i-=r.screen.maxY),i<-(r.screen.maxY/2)&&(i+=r.screen.maxY),new n(e,i)}rotate(t){return new n(this.x*Math.cos(t)-this.y*Math.sin(t),this.x*Math.sin(t)+this.y*Math.cos(t))}angleTo(t){return Math.atan2(this.x*t.y-this.y*t.x,this.x*t.x+this.y*t.y)}add(t){return new n(this.x+t.x,this.y+t.y)}subtract(t){return new n(this.x-t.x,this.y-t.y)}equals(t){return this.x===t.x&&this.y===t.y}scaleByScalar(t){return new n(this.x*t,this.y*t)}scaleToLength(t){return this.length?this.scaleByScalar(t/this.length):this}isParallelTo(t){return this.x*t.y==this.y*t.x}normalize(){return 0<=this.x&&0<=this.y?this:new n((this.x%r.screen.maxX+r.screen.maxX)%r.screen.maxX,(this.y%r.screen.maxY+r.screen.maxY)%r.screen.maxY)}toHeading(){return Math.atan2(this.y,this.x)}toString(){return`[${this.x}, ${this.y}]`}};var T=1e3,v=class{static getFpsCounter(){return this.fpsCounter||(this.fpsCounter=new v)}constructor(){this.fpsLabel=document.getElementById("fps-status"),this.recentFrames=[]}countFrame(){this.recentFrames.push(performance.now())}getFPS(){let t=performance.now();return this.recentFrames.filter(e=>e>=t-T).length}updateFps(){this.fpsLabel.textContent=this.getFPS().toString()}};var V=class{constructor(t){this.fpsCounter=v.getFpsCounter(),this.cameraPosition=new n(window.innerWidth,window.innerHeight),this.canvas=t;let e=this.canvas.getContext("2d");if(e)this.ctx=e;else throw new Error("could not get canvas context");this.canvas.height=r.screen.maxY,this.canvas.width=r.screen.maxX,this.setScreenSize()}onclick(t){this.canvas.onclick=t}setScreenSize(){window&&(r.screen.maxX=window.innerWidth,r.screen.maxY=window.innerHeight),this.ctx.canvas.width=r.screen.maxX,this.ctx.canvas.height=r.screen.maxY}draw(t,e=new n(window.innerWidth/2,window.innerHeight/2)){this.cameraPosition=e,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.setScreenSize(),this.drawBackground(),this.drawGhosts(t),t.forEach(i=>{this.drawCreature(i)}),this.fpsCounter.countFrame(),this.fpsCounter.updateFps()}drawBackground(){let t=window.innerWidth,e=window.innerHeight,{x:i,y:o}=this.cameraPosition;for(let s=0;s<t;s+=200)for(let c=0;c<e;c+=200){let m=(s+t-i)%t,b=(c+e-o)%e;this.ctx.beginPath(),this.ctx.arc(m,b,2,0,2*Math.PI),this.ctx.fillStyle="silver",this.ctx.fill()}}drawGhosts(t){if(!!r.creature.maxHistory)for(let e=0;e<r.creature.maxHistory;e++)t.forEach(i=>{this.drawGhost(i,e)})}drawGhost(t,e){this.drawCreatureBody(t,e)}drawCreature(t){this.drawCreatureBody(t),this.drawCreatureBeak(t)}getPositionInCameraSpace(t){return t.add(new n(window.innerWidth/2,window.innerHeight/2)).subtract(this.cameraPosition).normalize()}getPositionInWorldSpace(t){return t.subtract(new n(window.innerWidth/2,window.innerHeight/2)).add(this.cameraPosition).normalize()}drawCreatureBody(t,e){let i=e?t.history[e]:t.position;i=this.getPositionInCameraSpace(i);let o=e?t.size*((e+1)/(r.creature.maxHistory+1)):t.size;this.ctx.beginPath(),this.ctx.arc(i.x,i.y,o,0,2*Math.PI),this.ctx.fillStyle=t.colour,this.ctx.fill()}drawCreatureBeak(t){let e=this.getPositionInCameraSpace(t.position);this.ctx.beginPath(),this.ctx.arc(e.x+(t.size+1)*Math.cos(t.heading),e.y+(t.size+1)*Math.sin(t.heading),t.size/2,0,2*Math.PI),this.ctx.fillStyle="black",this.ctx.fill()}};var M=class{constructor(t,e,i){this.left=!1;this.right=!1;this.up=!1;this.down=!1;this.canvas=t,this.createBoid=e,this.createHunter=i,this.separationLabel=document.getElementById("separation-status"),this.alignmentLabel=document.getElementById("alignment-status"),this.cohesionLabel=document.getElementById("cohesion-status"),this.canvas.onclick(o=>{this.handleMouseClick(o)}),window.addEventListener("keyup",o=>{this.handleKeyUp(o)}),window.addEventListener("keyup",o=>{this.setArrow(o.key,!1)}),window.addEventListener("keydown",o=>{this.setArrow(o.key,!0)})}handleMouseClick(t){let e=this.canvas.getPositionInWorldSpace(new n(t.clientX,t.clientY));t.ctrlKey||t.metaKey?this.createHunter(e):this.createBoid(e)}handleKeyUp(t){let e="1",i="2",o="3";switch(t.key){case e:this.toggleSeparation();break;case i:this.toggleAlignment();break;case o:this.toggleCohesion();break;default:return}}toggleSeparation(){r.boid.repulsionRadius?(r.boid.repulsionRadius=0,this.separationLabel.textContent="OFF",this.separationLabel.style.color="red"):(r.boid.repulsionRadius=r.boid.repulsionRadiusDefault,this.separationLabel.textContent="ON",this.separationLabel.style.color="green")}toggleAlignment(){r.boid.alignmentRadius?(r.boid.alignmentRadius=0,this.alignmentLabel.textContent="OFF",this.alignmentLabel.style.color="red"):(r.boid.alignmentRadius=r.boid.alignmentRadiusDefault,this.alignmentLabel.textContent="ON",this.alignmentLabel.style.color="green")}toggleCohesion(){r.boid.attractionRadius?(r.boid.attractionRadius=0,this.cohesionLabel.textContent="OFF",this.cohesionLabel.style.color="red"):(r.boid.attractionRadius=r.boid.attractionRadiusDefault,this.cohesionLabel.textContent="ON",this.cohesionLabel.style.color="green")}getHeadingUpdate(){return .1*(+this.right-+this.left)}getSpeedUpdate(){return .5*(+this.up-+this.down)}setArrow(t,e){switch(t){case"ArrowLeft":this.left=e;break;case"ArrowRight":this.right=e;break;case"ArrowUp":this.up=e;break;case"ArrowDown":this.down=e;break;default:return}}};var h=class{distanceToCreature(t){return this.position.distance(t.position)}updateHistory(){this.history.push(this.position),this.history=this.history.slice(1)}velocity(){return n.fromHeadingAndSpeed(this.heading,this.speed)}};var H=class{constructor(t,e,i=Math.random()){this.input=t,this.output=e,this.weight=i}getNormalizedOutput(){return 2*this.input.value*this.weight}};var x=class{constructor(){this.inputs=[],this.outputs=[],this.value=0}connectOutput(t){this.outputs.push(t)}connectInput(t){this.inputs.push(t)}static connectPair(t,e){let i=new H(t,e);t.connectOutput(i),e.connectInput(i)}updateValue(){this.step3Function()}step2Function(){let e=this.inputs.reduce((i,o)=>i+o.getNormalizedOutput(),0)/this.inputs.length;this.value=e<.5?0:1}step3Function(){let e=this.inputs.reduce((i,o)=>i+o.getNormalizedOutput(),0)/this.inputs.length;if(e<1/3){this.value=0;return}if(e<2/3){this.value=.5;return}this.value=1}};var C=class{constructor(t){this.neurons=[];for(let e=0;e<t;e++)this.neurons.push(new x)}connectPriorLayer(t){this.neurons.forEach(e=>{t.neurons.forEach(i=>{x.connectPair(i,e)})})}injectInputVector(t){for(let e=0;e<t.length;e++)this.neurons[e].value=t[e]}updateValues(){this.neurons.forEach(t=>t.updateValue())}outputVector(){return this.neurons.map(t=>t.value)}};var I=class{constructor(t){let e=new C(t[0]);this.layers=[e];let i=e;for(let o=1;o<t.length;o++){let s=new C(t[o]);s.connectPriorLayer(i),this.layers.push(s),i=s}}processInput(t){this.injectInputVectorToInputLayer(t);for(let e=1;e<this.layers.length;e++)this.layers[e].updateValues();return this.layers[this.layers.length-1].outputVector()}injectInputVectorToInputLayer(t){this.layers[0].injectInputVector(t)}};var F=[1,3,2],w=class extends h{constructor(t=0,e,i){super();this.id=t;this.creatureStorage=e;this.colour=r.hunter.defaultColour,this.maxSpeed=r.hunter.maxSpeed,this.minSpeed=r.hunter.minSpeed,this.size=r.hunter.size,this.heading=0,this.speed=0,this.history=[],this.position=i||new n(Math.random()*r.screen.maxX,Math.random()*r.screen.maxY);for(let o=0;o<r.creature.maxHistory;o++)this.history.push(this.position);this.initializeVelocity(),this.net=new I(F)}initializeVelocity(){this.heading=Math.random()*2*Math.PI,this.speed=r.hunter.minSpeed}update(){this.eat(),this.move(),this.updateHistory()}eat(){this.creatureStorage.getBoidsInArea(this.position,r.hunter.eatRadius).forEach(t=>t.die())}move(){this.updateHistory(),this.position=this.position.add(this.velocity()).normalize();let t=this.getNeuralNetInputVector(),e=this.net.processInput(t);this.parseOutputToAction(e)}getNeuralNetInputVector(){let t=this.creatureStorage.getAllBoids().sort((s,c)=>s.distanceToCreature(this)-c.distanceToCreature(this))[0],e=this.position.vectorTo(t.position);return[this.velocity().angleTo(e)/(2*Math.PI)+.5]}parseOutputToAction(t){let e=t[0],i=this.heading-r.creature.turningMax,o=r.creature.turningMax*2;this.heading=i+e*o;let s=t[1],c=this.speed-r.creature.acceleration,m=r.creature.acceleration*2,b=c+m*s;this.speed=Math.min(Math.max(b,0),r.hunter.maxSpeed)}};var k=class{constructor(t,e){this.weightedVector=t;this.color=e}};var p=class{constructor(t,e){this.getIdealWeightedHeading=t;this.getColor=e}getCurrentPriority(){let t=this.getIdealWeightedHeading();return t.weight>0?new k(t,this.getColor()):null}};var u=class{constructor(t=new n,e=0){this.vector=t;this.weight=e}static average(t){if(t.length===0)return new n;let e=t.reduce((i,o)=>({vector:i.vector.add(o.vector.scaleByScalar(o.weight)),weight:i.weight+o.weight}),{vector:new n,weight:0});return e.vector.scaleByScalar(1/e.weight)}};var B=class extends h{constructor(t=0,e,i){super();this.id=t;this.creatureStorage=e;this.colour="black",this.position=i||new n(Math.random()*r.screen.maxX,Math.random()*r.screen.maxY),this.history=[];for(let o=0;o<r.creature.maxHistory;o++)this.history.push(this.position);this.initializeVelocity()}distanceToCreature(t){return this.position.distance(t.position)}move(){this.updateHistory(),this.position=this.position.add(this.velocity()).normalize(),this.updateHeading()}updateHeading(){let t=this.getCurrentPriorities().sort((e,i)=>i.weightedVector.weight-e.weightedVector.weight);if(t.length===0){this.defaultBehaviour();return}this.colour=t[0].color,this.updateHeadingTowards(u.average(t.map(e=>e.weightedVector)))}getCurrentPriorities(){return this.behaviours.map(t=>t.getCurrentPriority()).filter(t=>t&&t.weightedVector.vector.length&&t.weightedVector.weight)}defaultBehaviour(){this.colour=this.defaultColour,this.speed=Math.max(this.velocity.length-r.creature.acceleration,this.minSpeed);let t=2*r.creature.turningMax*Math.random()-r.creature.turningMax;this.heading=this.heading+t}updateHeadingTowards(t){if(!t)return;let e=Math.max(Math.min(t.length,this.maxSpeed),this.minSpeed);e=Math.max(Math.min(e,this.speed+r.creature.acceleration),this.speed-r.creature.acceleration),this.speed=e;let i=this.velocity().angleTo(t),o=Math.max(Math.min(i,r.creature.turningMax),-r.creature.turningMax);this.heading=this.heading+o+2*r.creature.headingFuzz*Math.random()-r.creature.headingFuzz}nearestCreatureToPosition(t){if(t.length===0)throw new Error("Nearest creature is undefined for zero creatures");return t.reduce((e,i)=>{let o=this.position.vectorTo(i.position).length;return e.distance>o?{distance:o,nearest:i}:e},{distance:this.position.vectorTo(t[0].position).length,nearest:t[0]}).nearest}};var d=class extends B{constructor(t,e,i){super(t,e,i);this.defaultColour=r.boid.defaultColour,this.maxSpeed=r.boid.maxSpeed,this.minSpeed=r.boid.minSpeed,this.size=r.boid.size,this.fearCountdown=0,this.heading=2*Math.PI*Math.random(),this.speed=r.boid.maxSpeed,this.behaviours=[new p(()=>this.hunterEvasion(),()=>"red"),new p(()=>this.repulsion(),()=>this.fearCountdown?"red":"orange"),new p(()=>this.alignment(),()=>this.fearCountdown?"red":"blue"),new p(()=>this.attraction(),()=>this.fearCountdown?"red":"green")]}initializeVelocity(){this.heading=Math.random()*2*Math.PI,this.speed=r.boid.maxSpeed}update(){this.fearCountdown&&this.fearCountdown--,this.move()}hunterEvasion(){let t=this.creatureStorage.getHuntersInArea(this.position,r.boid.visionRadius);if(t.length===0)return new u;this.fearCountdown=r.boid.fearDuration;let i=this.nearestCreatureToPosition(t).position.vectorTo(this.position);return new u(i.scaleToLength(this.maxSpeed),100)}repulsion(){let t=this.creatureStorage.getBoidsOrPlayersInArea(this.position,r.boid.repulsionRadius).filter(o=>o!==this);if(t.length===0)return new u;let e=t.map(o=>o.position.vectorTo(this.position)).map(o=>new u(o,this.repulsionWeightFrom(o))),i=e.reduce((o,s)=>o+s.weight,0);return new u(u.average(e),i)}repulsionWeightFrom(t){let i=(r.boid.repulsionRadius-t.length)/r.boid.repulsionRadius;return Math.pow(i,2)*r.boid.repulsionRadius}alignment(){let t=this.creatureStorage.getBoidsOrPlayersInArea(this.position,r.boid.alignmentRadius).filter(i=>i!==this);if(t.length===0)return new u;let e=n.average(t.map(i=>i.velocity()));return new u(this.fearCountdown?e.scaleToLength(this.maxSpeed):e,15)}attraction(){let t=this.creatureStorage.getBoidsOrPlayersInArea(this.position,r.boid.attractionRadius).filter(i=>i!==this);if(t.length===0)return new u;let e=this.nearestCreatureToPosition(t);return new u(this.position.vectorTo(e.position).scaleToLength(this.fearCountdown?this.maxSpeed:e.speed*1.1),10)}die(){this.creatureStorage.remove(this.id)}};var y=class extends h{constructor(t){super();this.inputHandler=t;this.colour="black";this.size=6;this.heading=0;this.speed=4;this.history=[];this.position=new n(window.innerWidth/2,window.innerHeight/2);for(let e=0;e<r.creature.maxHistory;e++)this.history.push(this.position)}update(){this.updateHistory(),this.heading+=this.inputHandler.getHeadingUpdate(),this.speed+=this.inputHandler.getSpeedUpdate(),this.speed=Math.max(Math.min(this.speed,r.player.maxSpeed),r.player.minSpeed),this.position=this.position.add(this.velocity()).normalize()}};var l=100,P=class{constructor(t){this.inputHandler=t;this.nextId=0,this.creatures=new Map,this.bucketMap=[],this.bucketColumns=1,this.bucketRows=1,this.update()}update(){this.resetBucketMap(),this.creatures.forEach(t=>{let e=Math.min(Math.floor(t.position.x/l),this.bucketColumns-1),i=Math.min(Math.floor(t.position.y/l),this.bucketRows-1);this.bucketMap[e][i].push(t)})}addHunter(t){let e=new w(this.nextId,this,t);return this.creatures.set(this.nextId,e),this.nextId++,e}addBoid(t){let e=new d(this.nextId,this,t);return this.creatures.set(this.nextId,e),this.nextId++,e}addPlayerFish(){let t=new y(this.inputHandler);return this.creatures.set(this.nextId,t),this.nextId++,t}getAllHunters(){return[...this.creatures.values()].filter(t=>t instanceof w)}getAllBoids(){return[...this.creatures.values()].filter(t=>t instanceof d)}getAllCreatures(){return[...this.creatures.values()]}getHuntersInArea(t,e){return this.getCreaturesInArea(t,e).filter(i=>i instanceof w&&i.position.distance(t)<e)}getBoidsInArea(t,e){return this.getCreaturesInArea(t,e).filter(i=>i instanceof d&&i.position.distance(t)<e)}getBoidsOrPlayersInArea(t,e){return this.getCreaturesInArea(t,e).filter(i=>(i instanceof d||i instanceof y)&&i.position.distance(t)<e)}getCreaturesInArea(t,e){let i=Math.floor(t.x/l),o=Math.floor(t.y/l),s=Math.ceil(e/l),c=(i-s+this.bucketColumns)%this.bucketColumns,m=(i+s+1)%this.bucketColumns,b=(o-s+this.bucketRows)%this.bucketRows,R=(o+s+1)%this.bucketRows,S=[];for(let g=c;g!==m;g++,g=g%this.bucketColumns)for(let f=b;f!==R;f++,f=f%this.bucketRows)S=S.concat(this.bucketMap[g][f]);return S}getHunterCount(){return this.getAllHunters().length}getBoidCount(){return this.getAllBoids().length}remove(t){this.creatures.delete(t)}resetBucketMap(){this.bucketMap=[],this.bucketColumns=Math.ceil(r.screen.maxX/l),this.bucketRows=Math.ceil(r.screen.maxY/l);for(let t=0;t<this.bucketColumns;t++){let e=[];for(let i=0;i<this.bucketRows;i++)e.push([]);this.bucketMap.push(e)}}};var L=class{constructor(){this.fpsTarget=60;let t=document.getElementById("canvas");if(!t)throw new Error("couldn't find 'canvas' on document");this.canvas=new V(t);let e=new M(this.canvas,i=>this.createBoid(i),i=>this.createHunter(i));this.creatureStorage=new P(e);for(let i=0;i<r.boid.quantity;i++)this.creatureStorage.addBoid();for(let i=0;i<r.hunter.quantity;i++)this.creatureStorage.addHunter();this.playerFish=this.creatureStorage.addPlayerFish()}createBoid(t){this.creatureStorage.addBoid(t)}createHunter(t){this.creatureStorage.addHunter(t)}runSimulation(){this.tick(performance.now(),0)}tick(t,e){let i=performance.now(),o=i-t;for(t=i,e+=o;e>=1e3/this.fpsTarget;)this.updateSimulation(),e-=1e3/this.fpsTarget;this.renderSimulation(),setTimeout(()=>this.tick(t,e),0)}updateSimulation(){this.creatureStorage.update();for(let t of this.creatureStorage.getAllBoids())t.update();for(let t of this.creatureStorage.getAllHunters())t.update();this.playerFish.update()}renderSimulation(){this.canvas.draw(this.creatureStorage.getAllCreatures(),this.playerFish.position),this.updateHunterCountDisplay(this.creatureStorage.getHunterCount()),this.updateBoidCountDisplay(this.creatureStorage.getBoidCount())}updateHunterCountDisplay(t){let e=document.getElementById("number-of-hunters");e&&(e.textContent=`${t}`)}updateBoidCountDisplay(t){let e=document.getElementById("number-of-boids");e&&(e.textContent=`${t}`)}};document.addEventListener("DOMContentLoaded",()=>{new L().runSimulation()},!1);})();
