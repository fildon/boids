(()=>{var i={boid:{alignmentRadius:40,alignmentRadiusDefault:40,attractionRadius:200,attractionRadiusDefault:200,defaultColour:"LightSteelBlue",fearDuration:30,maxSpeed:6,minSpeed:3,quantity:100,repulsionRadius:30,repulsionRadiusDefault:30,size:4,visionRadius:200},creature:{acceleration:.2,headingFuzz:.05,maxHistory:5,turningMax:.2},hunter:{defaultColour:"pink",eatRadius:20,maxSpeed:5,minSpeed:0,quantity:0,size:8,visionRadius:90},player:{maxSpeed:64,minSpeed:0},screen:{maxX:1e3,maxY:1e3}};var n=class{static average(t){return t.length===0?new n:t.reduce((r,o)=>r.add(o)).scaleByScalar(1/t.length)}static fromHeadingAndSpeed(t,e){return e?new n(e*Math.cos(t),e*Math.sin(t)):new n(0,0)}constructor(t=0,e=0){this.x=t%i.screen.maxX,this.y=e%i.screen.maxY,this.length=Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}unitVector(){return this.scaleByScalar(1/this.length)}distance(t){return this.vectorTo(t).length}vectorTo(t){let e=(t.x-this.x)%i.screen.maxX;e>i.screen.maxX/2&&(e-=i.screen.maxX),e<-(i.screen.maxX/2)&&(e+=i.screen.maxX);let r=(t.y-this.y)%i.screen.maxY;return r>i.screen.maxY/2&&(r-=i.screen.maxY),r<-(i.screen.maxY/2)&&(r+=i.screen.maxY),new n(e,r)}rotate(t){return new n(this.x*Math.cos(t)-this.y*Math.sin(t),this.x*Math.sin(t)+this.y*Math.cos(t))}angleTo(t){return Math.atan2(this.x*t.y-this.y*t.x,this.x*t.x+this.y*t.y)}add(t){return new n(this.x+t.x,this.y+t.y)}subtract(t){return new n(this.x-t.x,this.y-t.y)}equals(t){return this.x===t.x&&this.y===t.y}scaleByScalar(t){return new n(this.x*t,this.y*t)}scaleToLength(t){return this.length?this.scaleByScalar(t/this.length):this}isParallelTo(t){return this.x*t.y==this.y*t.x}normalize(){return 0<=this.x&&0<=this.y?this:new n((this.x%i.screen.maxX+i.screen.maxX)%i.screen.maxX,(this.y%i.screen.maxY+i.screen.maxY)%i.screen.maxY)}toHeading(){return Math.atan2(this.y,this.x)}toString(){return`[${this.x}, ${this.y}]`}};var R=1e3,m=class{static getFpsCounter(){return this.fpsCounter||(this.fpsCounter=new m)}constructor(){this.fpsLabel=document.getElementById("fps-status"),this.recentFrames=[]}countFrame(){this.recentFrames.push(performance.now())}getFPS(){let t=performance.now();return this.recentFrames.filter(e=>e>=t-R).length}updateFps(){this.fpsLabel.textContent=this.getFPS().toString()}};var S=class{constructor(t){this.fpsCounter=m.getFpsCounter(),this.cameraPosition=new n(window.innerWidth,window.innerHeight),this.canvas=t;let e=this.canvas.getContext("2d");if(e)this.ctx=e;else throw new Error("could not get canvas context");this.canvas.height=i.screen.maxY,this.canvas.width=i.screen.maxX,this.setScreenSize()}onclick(t){this.canvas.onclick=t}setScreenSize(){window&&(i.screen.maxX=window.innerWidth,i.screen.maxY=window.innerHeight),this.ctx.canvas.width=i.screen.maxX,this.ctx.canvas.height=i.screen.maxY}draw(t,e=new n(window.innerWidth/2,window.innerHeight/2)){this.cameraPosition=e,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.setScreenSize(),this.drawGhosts(t),t.forEach(r=>{this.drawCreature(r)}),this.fpsCounter.countFrame(),this.fpsCounter.updateFps()}drawGhosts(t){if(!!i.creature.maxHistory)for(let e=0;e<i.creature.maxHistory;e++)t.forEach(r=>{this.drawGhost(r,e)})}drawGhost(t,e){this.drawCreatureBody(t,e)}drawCreature(t){this.drawCreatureBody(t),this.drawCreatureBeak(t)}getPositionInCameraSpace(t){return t.add(new n(window.innerWidth/2,window.innerHeight/2)).subtract(this.cameraPosition).normalize()}getPositionInWorldSpace(t){return t.subtract(new n(window.innerWidth/2,window.innerHeight/2)).add(this.cameraPosition).normalize()}drawCreatureBody(t,e){let r=e?t.history[e]:t.position;r=this.getPositionInCameraSpace(r);let o=e?t.size*((e+1)/(i.creature.maxHistory+1)):t.size;this.ctx.beginPath(),this.ctx.arc(r.x,r.y,o,0,2*Math.PI),this.ctx.fillStyle=t.colour,this.ctx.fill()}drawCreatureBeak(t){let e=this.getPositionInCameraSpace(t.position);this.ctx.beginPath(),this.ctx.arc(e.x+(t.size+1)*Math.cos(t.heading),e.y+(t.size+1)*Math.sin(t.heading),t.size/2,0,2*Math.PI),this.ctx.fillStyle="black",this.ctx.fill()}};var V=class{constructor(t,e,r){this.canvas=t,this.createBoid=e,this.createHunter=r,this.separationLabel=document.getElementById("separation-status"),this.alignmentLabel=document.getElementById("alignment-status"),this.cohesionLabel=document.getElementById("cohesion-status"),this.canvas.onclick(o=>{this.handleMouseClick(o)}),window.addEventListener("keyup",o=>{this.handleKeyUp(o)})}handleMouseClick(t){let e=this.canvas.getPositionInWorldSpace(new n(t.clientX,t.clientY));t.ctrlKey||t.metaKey?this.createHunter(e):this.createBoid(e)}handleKeyUp(t){let e="1",r="2",o="3";switch(t.key){case e:this.toggleSeparation();break;case r:this.toggleAlignment();break;case o:this.toggleCohesion();break;default:return}}toggleSeparation(){i.boid.repulsionRadius?(i.boid.repulsionRadius=0,this.separationLabel.textContent="OFF",this.separationLabel.style.color="red"):(i.boid.repulsionRadius=i.boid.repulsionRadiusDefault,this.separationLabel.textContent="ON",this.separationLabel.style.color="green")}toggleAlignment(){i.boid.alignmentRadius?(i.boid.alignmentRadius=0,this.alignmentLabel.textContent="OFF",this.alignmentLabel.style.color="red"):(i.boid.alignmentRadius=i.boid.alignmentRadiusDefault,this.alignmentLabel.textContent="ON",this.alignmentLabel.style.color="green")}toggleCohesion(){i.boid.attractionRadius?(i.boid.attractionRadius=0,this.cohesionLabel.textContent="OFF",this.cohesionLabel.style.color="red"):(i.boid.attractionRadius=i.boid.attractionRadiusDefault,this.cohesionLabel.textContent="ON",this.cohesionLabel.style.color="green")}};var b=class{distanceToCreature(t){return this.position.distance(t.position)}updateHistory(){this.history.push(this.position),this.history=this.history.slice(1)}velocity(){return n.fromHeadingAndSpeed(this.heading,this.speed)}};var M=class{constructor(t,e,r=Math.random()){this.input=t,this.output=e,this.weight=r}getNormalizedOutput(){return 2*this.input.value*this.weight}};var v=class{constructor(){this.inputs=[],this.outputs=[],this.value=0}connectOutput(t){this.outputs.push(t)}connectInput(t){this.inputs.push(t)}static connectPair(t,e){let r=new M(t,e);t.connectOutput(r),e.connectInput(r)}updateValue(){this.step3Function()}step2Function(){let e=this.inputs.reduce((r,o)=>r+o.getNormalizedOutput(),0)/this.inputs.length;this.value=e<.5?0:1}step3Function(){let e=this.inputs.reduce((r,o)=>r+o.getNormalizedOutput(),0)/this.inputs.length;if(e<1/3){this.value=0;return}if(e<2/3){this.value=.5;return}this.value=1}};var w=class{constructor(t){this.neurons=[];for(let e=0;e<t;e++)this.neurons.push(new v)}connectPriorLayer(t){this.neurons.forEach(e=>{t.neurons.forEach(r=>{v.connectPair(r,e)})})}injectInputVector(t){for(let e=0;e<t.length;e++)this.neurons[e].value=t[e]}updateValues(){this.neurons.forEach(t=>t.updateValue())}outputVector(){return this.neurons.map(t=>t.value)}};var H=class{constructor(t){let e=new w(t[0]);this.layers=[e];let r=e;for(let o=1;o<t.length;o++){let u=new w(t[o]);u.connectPriorLayer(r),this.layers.push(u),r=u}}processInput(t){this.injectInputVectorToInputLayer(t);for(let e=1;e<this.layers.length;e++)this.layers[e].updateValues();return this.layers[this.layers.length-1].outputVector()}injectInputVectorToInputLayer(t){this.layers[0].injectInputVector(t)}};var P=[1,3,2],g=class extends b{constructor(t=0,e,r){super();this.id=t;this.creatureStorage=e;this.colour=i.hunter.defaultColour,this.maxSpeed=i.hunter.maxSpeed,this.minSpeed=i.hunter.minSpeed,this.size=i.hunter.size,this.heading=0,this.speed=0,this.history=[],this.position=r||new n(Math.random()*i.screen.maxX,Math.random()*i.screen.maxY);for(let o=0;o<i.creature.maxHistory;o++)this.history.push(this.position);this.initializeVelocity(),this.net=new H(P)}initializeVelocity(){this.heading=Math.random()*2*Math.PI,this.speed=i.hunter.minSpeed}update(){this.eat(),this.move(),this.updateHistory()}eat(){this.creatureStorage.getBoidsInArea(this.position,i.hunter.eatRadius).forEach(t=>t.die())}move(){this.updateHistory(),this.position=this.position.add(this.velocity()).normalize();let t=this.getNeuralNetInputVector(),e=this.net.processInput(t);this.parseOutputToAction(e)}getNeuralNetInputVector(){let t=this.creatureStorage.getAllBoids().sort((u,l)=>u.distanceToCreature(this)-l.distanceToCreature(this))[0],e=this.position.vectorTo(t.position);return[this.velocity().angleTo(e)/(2*Math.PI)+.5]}parseOutputToAction(t){let e=t[0],r=this.heading-i.creature.turningMax,o=i.creature.turningMax*2;this.heading=r+e*o;let u=t[1],l=this.speed-i.creature.acceleration,x=i.creature.acceleration*2,y=l+x*u;this.speed=Math.min(Math.max(y,0),i.hunter.maxSpeed)}};var B=class{constructor(t,e){this.weightedVector=t;this.color=e}};var h=class{constructor(t,e){this.getIdealWeightedHeading=t;this.getColor=e}getCurrentPriority(){let t=this.getIdealWeightedHeading();return t.weight>0?new B(t,this.getColor()):null}};var s=class{constructor(t=new n,e=0){this.vector=t;this.weight=e}static average(t){if(t.length===0)return new n;let e=t.reduce((r,o)=>({vector:r.vector.add(o.vector.scaleByScalar(o.weight)),weight:r.weight+o.weight}),{vector:new n,weight:0});return e.vector.scaleByScalar(1/e.weight)}};var I=class extends b{constructor(t=0,e,r){super();this.id=t;this.creatureStorage=e;this.colour="black",this.position=r||new n(Math.random()*i.screen.maxX,Math.random()*i.screen.maxY),this.history=[];for(let o=0;o<i.creature.maxHistory;o++)this.history.push(this.position);this.initializeVelocity()}distanceToCreature(t){return this.position.distance(t.position)}move(){this.updateHistory(),this.position=this.position.add(this.velocity()).normalize(),this.updateHeading()}updateHeading(){let t=this.getCurrentPriorities().sort((e,r)=>r.weightedVector.weight-e.weightedVector.weight);if(t.length===0){this.defaultBehaviour();return}this.colour=t[0].color,this.updateHeadingTowards(s.average(t.map(e=>e.weightedVector)))}getCurrentPriorities(){return this.behaviours.map(t=>t.getCurrentPriority()).filter(t=>t&&t.weightedVector.vector.length&&t.weightedVector.weight)}defaultBehaviour(){this.colour=this.defaultColour,this.speed=Math.max(this.velocity.length-i.creature.acceleration,this.minSpeed);let t=2*i.creature.turningMax*Math.random()-i.creature.turningMax;this.heading=this.heading+t}updateHeadingTowards(t){if(!t)return;let e=Math.max(Math.min(t.length,this.maxSpeed),this.minSpeed);e=Math.max(Math.min(e,this.speed+i.creature.acceleration),this.speed-i.creature.acceleration),this.speed=e;let r=this.velocity().angleTo(t),o=Math.max(Math.min(r,i.creature.turningMax),-i.creature.turningMax);this.heading=this.heading+o+2*i.creature.headingFuzz*Math.random()-i.creature.headingFuzz}nearestCreatureToPosition(t){if(t.length===0)throw new Error("Nearest creature is undefined for zero creatures");return t.reduce((e,r)=>{let o=this.position.vectorTo(r.position).length;return e.distance>o?{distance:o,nearest:r}:e},{distance:this.position.vectorTo(t[0].position).length,nearest:t[0]}).nearest}};var f=class extends I{constructor(t,e,r){super(t,e,r);this.defaultColour=i.boid.defaultColour,this.maxSpeed=i.boid.maxSpeed,this.minSpeed=i.boid.minSpeed,this.size=i.boid.size,this.fearCountdown=0,this.heading=2*Math.PI*Math.random(),this.speed=i.boid.maxSpeed,this.behaviours=[new h(()=>this.hunterEvasion(),()=>"red"),new h(()=>this.repulsion(),()=>this.fearCountdown?"red":"orange"),new h(()=>this.alignment(),()=>this.fearCountdown?"red":"blue"),new h(()=>this.attraction(),()=>this.fearCountdown?"red":"green")]}initializeVelocity(){this.heading=Math.random()*2*Math.PI,this.speed=i.boid.maxSpeed}update(){this.fearCountdown&&this.fearCountdown--,this.move()}hunterEvasion(){let t=this.creatureStorage.getHuntersInArea(this.position,i.boid.visionRadius);if(t.length===0)return new s;this.fearCountdown=i.boid.fearDuration;let r=this.nearestCreatureToPosition(t).position.vectorTo(this.position);return new s(r.scaleToLength(this.maxSpeed),100)}repulsion(){let t=this.creatureStorage.getBoidsInArea(this.position,i.boid.repulsionRadius).filter(o=>o!==this);if(t.length===0)return new s;let e=t.map(o=>o.position.vectorTo(this.position)).map(o=>new s(o,this.repulsionWeightFrom(o))),r=e.reduce((o,u)=>o+u.weight,0);return new s(s.average(e),r)}repulsionWeightFrom(t){let r=(i.boid.repulsionRadius-t.length)/i.boid.repulsionRadius;return Math.pow(r,2)*i.boid.repulsionRadius}alignment(){let t=this.creatureStorage.getBoidsInArea(this.position,i.boid.alignmentRadius).filter(r=>r!==this);if(t.length===0)return new s;let e=n.average(t.map(r=>r.velocity()));return new s(this.fearCountdown?e.scaleToLength(this.maxSpeed):e,15)}attraction(){let t=this.creatureStorage.getBoidsInArea(this.position,i.boid.attractionRadius).filter(r=>r!==this);if(t.length===0)return new s;let e=this.nearestCreatureToPosition(t);return new s(this.position.vectorTo(e.position).scaleToLength(this.fearCountdown?this.maxSpeed:e.speed*1.1),10)}die(){this.creatureStorage.remove(this.id)}};var c=100,k=class{constructor(){this.nextId=0,this.creatures=new Map,this.bucketMap=[],this.bucketColumns=1,this.bucketRows=1,this.update()}update(){this.resetBucketMap(),this.creatures.forEach(t=>{let e=Math.min(Math.floor(t.position.x/c),this.bucketColumns-1),r=Math.min(Math.floor(t.position.y/c),this.bucketRows-1);this.bucketMap[e][r].push(t)})}addHunter(t){let e=new g(this.nextId,this,t);return this.creatures.set(this.nextId,e),this.nextId++,e}addBoid(t){let e=new f(this.nextId,this,t);return this.creatures.set(this.nextId,e),this.nextId++,e}getAllHunters(){return[...this.creatures.values()].filter(t=>t instanceof g)}getAllBoids(){return[...this.creatures.values()].filter(t=>t instanceof f)}getAllCreatures(){return[...this.creatures.values()]}getHuntersInArea(t,e){return this.getCreaturesInArea(t,e).filter(r=>r instanceof g&&r.position.distance(t)<e)}getBoidsInArea(t,e){return this.getCreaturesInArea(t,e).filter(r=>r instanceof f&&r.position.distance(t)<e)}getCreaturesInArea(t,e){let r=Math.floor(t.x/c),o=Math.floor(t.y/c),u=Math.ceil(e/c),l=(r-u+this.bucketColumns)%this.bucketColumns,x=(r+u+1)%this.bucketColumns,y=(o-u+this.bucketRows)%this.bucketRows,T=(o+u+1)%this.bucketRows,C=[];for(let p=l;p!==x;p++,p=p%this.bucketColumns)for(let d=y;d!==T;d++,d=d%this.bucketRows)C=C.concat(this.bucketMap[p][d]);return C}getHunterCount(){return this.getAllHunters().length}getBoidCount(){return this.getAllBoids().length}remove(t){this.creatures.delete(t)}resetBucketMap(){this.bucketMap=[],this.bucketColumns=Math.ceil(i.screen.maxX/c),this.bucketRows=Math.ceil(i.screen.maxY/c);for(let t=0;t<this.bucketColumns;t++){let e=[];for(let r=0;r<this.bucketRows;r++)e.push([]);this.bucketMap.push(e)}}};var L=class{constructor(){this.fpsTarget=60;let t=document.getElementById("canvas");if(!t)throw new Error("couldn't find 'canvas' on document");this.canvas=new S(t),new V(this.canvas,e=>this.createBoid(e),e=>this.createHunter(e)),this.creatureStorage=new k;for(let e=0;e<i.boid.quantity;e++)this.creatureStorage.addBoid();for(let e=0;e<i.hunter.quantity;e++)this.creatureStorage.addHunter()}createBoid(t){this.creatureStorage.addBoid(t)}createHunter(t){this.creatureStorage.addHunter(t)}runSimulation(){this.tick(performance.now(),0)}tick(t,e){let r=performance.now(),o=r-t;for(t=r,e+=o;e>=1e3/this.fpsTarget;)this.updateSimulation(),e-=1e3/this.fpsTarget;this.renderSimulation(),setTimeout(()=>this.tick(t,e),0)}updateSimulation(){this.creatureStorage.update();for(let t of this.creatureStorage.getAllBoids())t.update();for(let t of this.creatureStorage.getAllHunters())t.update()}renderSimulation(){this.canvas.draw(this.creatureStorage.getAllCreatures()),this.updateHunterCountDisplay(this.creatureStorage.getHunterCount()),this.updateBoidCountDisplay(this.creatureStorage.getBoidCount())}updateHunterCountDisplay(t){let e=document.getElementById("number-of-hunters");e&&(e.textContent=`${t}`)}updateBoidCountDisplay(t){let e=document.getElementById("number-of-boids");e&&(e.textContent=`${t}`)}};document.addEventListener("DOMContentLoaded",()=>{new L().runSimulation()},!1);})();
